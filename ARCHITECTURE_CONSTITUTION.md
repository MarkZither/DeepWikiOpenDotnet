# DeepWiki Architecture Constitution

**Purpose**: Establish non-negotiable architectural principles and implementation practices for the multi-database data access layer.

---

## Database Implementation Principles

### 1. Entity Framework Core (EF Core) - MANDATORY
- **Rule**: ALL database operations MUST use Entity Framework Core 10.x
- **Rationale**: Provides abstraction, automatic migrations, and provider-agnostic design
- **Exception**: None. No manual ADO.NET, no raw SQL in repositories
- **Violation Impact**: Code review rejection, architectural debt

### 2. Database-Agnostic Model Layer
- **Rule**: `DocumentEntity` and shared interfaces live in `DeepWiki.Data` project ONLY
- **Rule**: Model uses `ReadOnlyMemory<float>` for embeddings (database-agnostic, zero-alloc)
- **Provider-Specific Types**: Conversion happens ONLY in provider layer (SqlServer, Postgres, etc.)
- **Rule**: No `SqlVector<T>`, `pgvector.Vector`, or database-specific types in model
- **Value Converters**: Providers use EF Core value converters to map model types to database types
- **Example Flow**:
  ```
  DocumentEntity (ReadOnlyMemory<float> embedding)
       ↓ ValueConverter
  SqlVector<float> (SQL Server provider)
       ↓ Database Type
  vector(1536) column (SQL Server 2025)
  ```

### 3. Migrations - TOOL-GENERATED ONLY
- **CRITICAL RULE**: Migrations are ALWAYS generated by `dotnet ef migrations add` command
- **NEVER**: Manually create .cs migration files
- **NEVER**: Manually write SQL in migration files
- **Setup**: Each provider project MUST include `IDesignTimeDbContextFactory<T>`
- **Process**:
  1. Modify entity configuration (add property, change column type, etc.)
  2. Run: `dotnet ef migrations add DescriptiveName -p src/DeepWiki.Data.[Provider]`
  3. Review generated migration file
  4. EF tool handles SQL syntax, indexes, constraints, type mapping
- **Why**: Tool knows database-specific SQL syntax, migrations are version-controlled, team stays synchronized

### 4. Multiple Database Support Strategy
- **Shared Layer**: Model + interfaces live in `DeepWiki.Data`
- **Provider Layers**: `DeepWiki.Data.SqlServer`, `DeepWiki.Data.Postgres`, etc.
- **Pattern**: Each provider implements same interfaces with database-specific queries
- **No Code Duplication**: Shared tests, different backends
- **Test Parity**: 100% same test suite passes for all providers

### 5. Vector Type Mapping

**SQL Server Implementation**:
- Column type: `vector(1536)` (native SQL Server 2025)
- Model type: `ReadOnlyMemory<float>`
- Provider type: `float[]` (intermediate conversion)
- Value converter: `ReadOnlyMemory<float>` ↔ `float[]` (model ↔ database)
- Index: HNSW algorithm with m=16, ef_construction=200

**PostgreSQL Implementation**:
- Column type: `vector(1536)` (pgvector extension)
- Model type: `ReadOnlyMemory<float>` (same as SQL Server - agnostic)
- Provider type: `pgvector.Vector` or `float[]`
- Value converter: Same mapping strategy as SQL Server
- Index: HNSW algorithm with m=16, ef_construction=200

**SQLite Implementation** (future):
- Column type: `BLOB` (store binary embedding data)
- Model type: `ReadOnlyMemory<float>` (same - agnostic)
- Provider type: `byte[]` (convert float[] to bytes)
- Value converter: `ReadOnlyMemory<float>` ↔ `byte[]`
- Index: Full-text or custom similarity search

### 6. Concurrency & Transactions
- **Optimistic Concurrency**: `UpdatedAt` property as `IsConcurrencyToken()`
- **Conflict Handling**: Catch `DbUpdateConcurrencyException` in application layer
- **Transactions**: Use `IDbContextTransaction` for multi-operation atomicity
- **Retry Policy**: SQL Server provider includes 3-retry exponential backoff for transient failures

---

## Code Organization

```
src/
├── DeepWiki.Data/
│   ├── Entities/
│   │   └── DocumentEntity.cs (13 properties, ReadOnlyMemory<float> embedding)
│   ├── Interfaces/
│   │   ├── IDocumentRepository.cs (CRUD operations)
│   │   └── IVectorStore.cs (Vector search - ReadOnlyMemory<float> queryEmbedding)
│   └── DeepWiki.Data.csproj (System.Text.Json only)
│
├── DeepWiki.Data.SqlServer/
│   ├── Configuration/
│   │   └── DocumentEntityConfiguration.cs (vector(1536) + HNSW index)
│   ├── DbContexts/
│   │   ├── SqlServerVectorDbContext.cs (DbSet<DocumentEntity>)
│   │   └── SqlServerVectorDbContextFactory.cs (IDesignTimeDbContextFactory)
│   ├── Repositories/
│   │   ├── SqlServerDocumentRepository.cs (IDocumentRepository impl)
│   │   └── SqlServerVectorStore.cs (IVectorStore impl)
│   ├── Health/
│   │   └── SqlServerHealthCheck.cs (Version validation, vector test)
│   ├── Migrations/
│   │   ├── 20260117000000_InitialCreate.cs (TOOL-GENERATED)
│   │   ├── 20260117000001_AddIndex.cs (TOOL-GENERATED)
│   │   └── SqlServerVectorDbContextModelSnapshot.cs (TOOL-GENERATED)
│   └── DeepWiki.Data.SqlServer.csproj
│
└── DeepWiki.Data.Postgres/ (same structure, pgvector-specific)

tests/
├── DeepWiki.Data.Tests/ (Unit tests - no DB)
├── DeepWiki.Data.SqlServer.Tests/
│   ├── Fixtures/
│   │   └── SqlServerFixture.cs (Testcontainers setup)
│   └── Integration/
│       ├── SqlServerDocumentRepositoryTests.cs
│       └── SqlServerVectorStoreTests.cs
└── DeepWiki.Data.Postgres.Tests/ (mirror structure)
```

---

## Implementation Checklist

### Phase 1.2: SQL Server ✅ (23/27 tasks)
- [x] EF Core 10.x configured
- [x] DocumentEntity uses `ReadOnlyMemory<float>`
- [x] DbContext + Configuration implemented
- [x] Repositories implemented
- [x] 21 integration tests passing with Testcontainers
- [x] HealthCheck implemented
- [ ] Migrations generated (T035-T036)
- [ ] Migrations tested on fresh instance (T037-T038)
- [ ] Bulk operations tests (T040-T041)
- [ ] Performance benchmarks (T042-T044)
- [ ] Documentation (T046)

### Phase 1.3: PostgreSQL (Future)
- Mirror Phase 1.2 with pgvector provider
- Identical model layer, provider-specific configuration
- 100% test parity with SQL Server
- Cross-database test validation

---

## Migration Workflow - REQUIRED PROCESS

### Adding a Column
```bash
# 1. Modify DocumentEntity.cs property
# 2. Run migration command
cd repo-root
dotnet ef migrations add AddNewProperty \
  -p src/DeepWiki.Data.SqlServer \
  -o Migrations

# 3. Review generated file (auto-generated, not manual)
# 4. No SQL modifications needed - EF handles it
# 5. Commit: git add src/DeepWiki.Data.SqlServer/Migrations/*.cs

# 6. Test on fresh database
dotnet test tests/DeepWiki.Data.SqlServer.Tests/
```

### Creating Index on Vector Column
```bash
# 1. Modify DocumentEntityConfiguration.cs
builder.HasIndex(d => d.Embedding)
    .HasDatabaseName("IX_Documents_Embedding_HNSW")
    .HasAnnotation("SqlServer:IndexMethod", "HNSW");

# 2. Generate migration
dotnet ef migrations add CreateVectorIndex -p src/DeepWiki.Data.SqlServer

# EF Core generates correct SQL:
# CREATE INDEX IX_Documents_Embedding_HNSW 
# ON Documents(Embedding) USING HNSW
```

### What NOT to Do ❌
```
❌ Create Migrations/20260117000000_InitialCreate.cs manually
❌ Write SQL by hand in migration file
❌ Edit ModelSnapshot.cs by hand
❌ Use raw SQL queries in repositories
❌ Create different migrations for different providers manually
```

---

## Design Decisions - LOCKED

1. **ReadOnlyMemory<float> for embeddings**: Zero-alloc, performance-optimized, stack-allocated
2. **EF Core value converters**: Enables database-agnostic model with provider-specific storage
3. **HNSW indexes**: SQL Server 2025 and PostgreSQL both support; optimized for vector similarity
4. **Testcontainers integration**: Real database containers for testing, not mocks
5. **IVectorStore interface**: Async, supports pagination, repository filtering, similarity search

---

## Performance Requirements (Non-Negotiable)

- Vector query <500ms @ 10K documents
- Vector query <2s @ 3M documents  
- Bulk upsert 1000 docs <10 seconds
- Memory <500MB for bulk operations
- 90%+ code coverage on data access layer

---

## Security Requirements

- Connection strings in configuration (not hardcoded)
- SQL injection prevention via EF Core parameterized queries (automatic)
- No raw SQL in repositories
- Health checks validate database version and vector support
- Sensitive data (passwords) never logged

---

**Last Updated**: 2026-01-17  
**Status**: Active - Enforced from Phase 1.2 forward  
**Violations**: Require architecture review + code changes before merge
