# Quick Start Guide - RAG API with PostgreSQL & Foundry

## What's Configured

‚úÖ **PostgreSQL with pgvector** - Managed by Aspire (automatic container)  
‚úÖ **Ollama embeddings** - Using local Ollama at http://localhost:11434  
‚úÖ **Document ingestion** - POST /api/documents/ingest  
‚úÖ **Semantic search** - POST /api/query  

## Prerequisites

1. **Ollama** installed and running with `nomic-embed-text` model
2. **Docker** installed (for PostgreSQL container via Aspire)

### Setup Ollama

```bash
# Install Ollama (if not already installed)
curl -fsSL https://ollama.com/install.sh | sh

# Pull the embedding model
ollama pull nomic-embed-text

# Verify it's running
ollama list
```

## Steps to Run

### 1. Run Database Migrations

First time only - create the PostgreSQL schema:

```bash
cd /home/mark/docker/deepwiki-open-dotnet

# Apply migrations to create tables and pgvector extension
dotnet ef database update --project src/DeepWiki.Data.Postgres --startup-project src/deepwiki-open-dotnet.ApiService
```

### 2. Start the Application

```bash
cd /home/mark/docker/deepwiki-open-dotnet/src/deepwiki-open-dotnet.AppHost
dotnet run
```

This will:
- Start Aspire Dashboard at http://localhost:18888
- Launch PostgreSQL container with pgvector
- Start the API service at http://localhost:XXXXX (check Aspire dashboard for port)
- Connect to your Ollama endpoint for embeddings

### 3. Test with HTTP File

Open `test-ingest-query.http` in VS Code and:

1. **Test #1: Ingest a document**
   - Click "Send Request" on the first POST request
   - Should return `{"successCount": 1, ...}`

2. **Test #4: Search for it**
   - Click "Send Request" on the query request
   - Should return documents with similarity scores

## Verify Configuration

Check the Aspire Dashboard logs for:

‚úÖ **Good signs:**
```
info: Using PostgreSQL vector store
info: Using Ollama embedding service with endpoint: http://localhost:11434
```

‚ùå **Bad signs:**
```
warn: Using NoOpVectorStore
warn: Using NoOpEmbeddingService
```

## Configuration Files

### AppHost (src/deepwiki-open-dotnet.AppHost/AppHost.cs)
- Provisions PostgreSQL with pgvector image
- Passes environment variables to API service
- Configures Ollama endpoint

### API Service Receives
- `VectorStore__Provider=postgres`
- `Embedding__Provider=ollama`
- `Embedding__Ollama__Endpoint=http://localhost:11434`
- `Embedding__Ollama__ModelId=nomic-embed-text`

‚ö†Ô∏è Note: The vector store provider is now strict by default. If `VectorStore:Provider` is set but unavailable, the API will throw an exception to fail fast. To allow the old NoOp fallback behavior set `VectorStore:AllowNoOpFallback=true` in the environment or `appsettings`.
- Connection string from Aspire

## Troubleshooting

### "No test matches the given testcase filter"
This is normal - it's just warnings from other test projects.

### "Embedding service unavailable"
- Check Ollama is running: `ollama list`
- Start Ollama if needed: `ollama serve`
- Verify model is available: `ollama pull nomic-embed-text`
- Update endpoint in `src/deepwiki-open-dotnet.AppHost/appsettings.Development.json`

### "PostgreSQL container not starting"
- Check Docker is running: `docker ps`
- Check Aspire dashboard for container logs
- Try: `docker pull pgvector/pgvector:pg17`

### "Migration errors"
- Ensure PostgreSQL container is running first
- Connection string is auto-generated by Aspire
- Check AppHost is running when applying migrations

## Next Steps

1. ‚úÖ Run migrations
2. ‚úÖ Start AppHost
3. ‚úÖ Test ingestion endpoint
4. ‚úÖ Test query endpoint
5. üéâ Build your RAG application!

## Aspire Dashboard

Access at http://localhost:18888

Features:
- View all running resources (Postgres, Redis, API, Web)
- Check logs for each service
- View metrics and traces
- Get connection strings
- Access pgAdmin (for PostgreSQL GUI)
