name: Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      skip_testcontainers:
        description: 'Skip Testcontainers database provisioning (use mock databases)'
        required: false
        default: 'false'

env:
  DOTNET_VERSION: '10.x'
  SOLUTION_PATH: 'deepwiki-open-dotnet.sln'

jobs:
  integration-tests:
    name: Integration Tests (Category=Integration)
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    # Required for Testcontainers
    services:
      docker:
        image: docker:dind
        options: --privileged

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/Directory.Build.props') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_PATH }}

      - name: Build solution
        run: dotnet build ${{ env.SOLUTION_PATH }} --no-restore --configuration Release

      - name: Run integration tests (SQL Server + Postgres via Testcontainers)
        env:
          # Testcontainers will provision databases automatically
          # These env vars can override defaults if needed
          TESTCONTAINERS_RYUK_DISABLED: 'false'
          DOCKER_HOST: 'unix:///var/run/docker.sock'
          # Allow tests to read connection strings from secrets if Testcontainers not used
          VECTOR_STORE_TEST_CONNECTION: ${{ secrets.VECTOR_STORE_TEST_CONNECTION }}
          POSTGRES_TEST_CONNECTION: ${{ secrets.POSTGRES_TEST_CONNECTION }}
        run: |
          # Run only tests marked with Category=Integration
          dotnet test ${{ env.SOLUTION_PATH }} \
            --no-build \
            --configuration Release \
            --filter "Category=Integration" \
            --logger "trx;LogFileName=integration-test-results.trx" \
            --logger "console;verbosity=normal" \
            --results-directory ./TestResults/integration \
            --collect:"XPlat Code Coverage" \
            --settings coverlet.runsettings

      - name: Upload integration test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: ./TestResults/integration/**
          retention-days: 14

      - name: Integration test summary
        if: always()
        run: |
          echo "## Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Count test results from trx files if available
          if [ -f "./TestResults/integration/integration-test-results.trx" ]; then
            # Basic summary extraction
            echo "Integration tests completed. See artifacts for detailed results." >> $GITHUB_STEP_SUMMARY
          else
            echo "No test results file found." >> $GITHUB_STEP_SUMMARY
          fi

  # Database-specific integration tests (optional, separate jobs for isolation)
  sqlserver-integration:
    name: SQL Server Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore and build
        run: |
          dotnet restore ${{ env.SOLUTION_PATH }}
          dotnet build ${{ env.SOLUTION_PATH }} --no-restore --configuration Release

      - name: Run SQL Server specific tests
        run: |
          dotnet test tests/DeepWiki.Data.SqlServer.Tests/DeepWiki.Data.SqlServer.Tests.csproj \
            --no-build \
            --configuration Release \
            --filter "Category=Integration" \
            --logger "trx;LogFileName=sqlserver-results.trx" \
            --results-directory ./TestResults/sqlserver \
          || echo "No SQL Server integration tests found or all skipped"

      - name: Upload SQL Server test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sqlserver-test-results
          path: ./TestResults/sqlserver/
          retention-days: 14

  postgres-integration:
    name: Postgres Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore and build
        run: |
          dotnet restore ${{ env.SOLUTION_PATH }}
          dotnet build ${{ env.SOLUTION_PATH }} --no-restore --configuration Release

      - name: Run Postgres specific tests
        run: |
          dotnet test tests/DeepWiki.Data.Postgres.Tests/DeepWiki.Data.Postgres.Tests.csproj \
            --no-build \
            --configuration Release \
            --filter "Category=Integration" \
            --logger "trx;LogFileName=postgres-results.trx" \
            --results-directory ./TestResults/postgres \
          || echo "No Postgres integration tests found or all skipped"

      - name: Upload Postgres test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: postgres-test-results
          path: ./TestResults/postgres/
          retention-days: 14
